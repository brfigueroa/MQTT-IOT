<!DOCTYPE html>
<html lang="es" ng-app="app">
<head>
    <meta charset="utf-8"/>
    <meta name = "viewport" content = "width=device-width,, user-scalable=no">
    <title>Prueba</title>
    <link rel="stylesheet" href="/css/bootstrap.css" />
</head>
<body ng-controller="UbiGeoCrtl">
    <div class"container">
        <h1>Internet de las Cosas</h1>
        <fieldset>
            <legend>Mqtt: Suscribirse/Publicar</legend>
            <label>Suscribirse: </label>
            <select ng-model="dpto" ng-options="d.coddep as d.desdep for d in dptos"></select>
            <label>Publicar: </label>
            <select ng-model="prov">
                <option ng-repeat="p in provs | filter:{coddep:dpto}" value="{{p.codpro}}">{{p.despro}}</option>
            </select>
        </fieldset>
        <p>Topico para Suscribirse: {{ dpto }}</p>
        <p>Topico para Publicar: {{ prov }}</p>
    </div>
    <script type="text/javascript" src="/js/angular.js"></script>
    <script type="text/javascript" src="/js/ubigeo.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.js"></script>
    <script type="text/javascript" src=" http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="/js/iphone-style-checkboxes.js"></script>
    <h3>Sensores UTPL Node.JS/MQTT</h3>
    <script type="text/javascript">
    google.load("visualization", "1", {packages: ["gauge"]});
    google.setOnLoadCallback(drawChart);
    google.setOnLoadCallback(drawChart2);
    function drawChart2() {

        var data = google.visualization.arrayToDataTable([
            ['Label', 'Value'],
            ['RUIDO', 1]

        ]);


        var options1 = {
            width: 400, height: 120,
            redFrom: 500, redTo: 600,
            yellowFrom: 450, yellowTo: 500,
            minorTicks: 5, max: 1000,
            min: 0

        };

        var chart = new google.visualization.Gauge(document.getElementById('chart_div2'));

        // chart.draw(data, options);

        setInterval(function () {
            data.setValue(0, 1, document.getElementById("numberMsg2").innerHTML);
            chart.draw(data, options1);
        }, 500);

    }

    function drawChart() {

        var data = google.visualization.arrayToDataTable([
            ['Label', 'Value'],
            ['LUZ', 1]

        ]);


        var options1 = {
            width: 400, height: 120,
            redFrom: 500, redTo: 600,
            yellowFrom: 450, yellowTo: 500,
            minorTicks: 5, max: 1000,
            min: 0

        };

        var chart = new google.visualization.Gauge(document.getElementById('chart_div'));

        // chart.draw(data, options);

        setInterval(function () {
            data.setValue(0, 1, document.getElementById("numberMsg1").innerHTML);
            chart.draw(data, options1);
        }, 500);

    }

    var socket = io.connect('http://192.168.0.11:5000');
    socket.on('connect', function () {
        socket.on('mqtt', function (msg) {
            var elmarr = msg.topic.split("/");
            var elm = elmarr[2];
            var json = JSON.parse(msg.payload);
            var ad = json["device"].id;
            var ad1 = json["device"].luz;
            var ad2 = json["device"].sonido;
            
            document.getElementById('numberMsg').innerHTML = ad;
            document.getElementById('numberMsg1').innerHTML = ad1;
            document.getElementById('numberMsg2').innerHTML = ad2;
            console.log(msg.topic + ' ' + msg.payload);
            if (msg.payload == "OFF") {
                if ($('input[name=led]').is(':checked')) {
                    $('input[name=led]').prop('checked',false).change();
                }
            }
            if (msg.payload == "OFF") {
                if (!$('input[name=led]').is(':checked')) {
                    $('input[name=led]').prop('checked',true).change();
                }
            }
            // $('#'.concat(elm)).html(msg.payload);
        });
        socket.emit('subscribe', {topic: 'utpl/IntelGalileo/sensor'});
    });

</script>
<script>
    $(document).ready(function () {
        $(':checkbox').iphoneStyle({
            onChange: function (elem, val) {
                if (val) {
                    socket.emit('publish', {topic: "utpl/IntelGalileo/led", payload: "ON"});
                } else {
                    socket.emit('publish', {topic: "utpl/IntelGalileo/led", payload: "OFF"});
                }
            }
        });
    });
</script>
<table class="tablegv" style="width: 500px;">
    <tbody>
        <tr class="tablegvHeader">
            <td colspan="2"><center>Valor</center></td>
</tr>
<tr>
    <td>Id</td>
    <td id="numberMsg"></td>
</tr>
<tr>
    <td>Luz</td>
    <td id="numberMsg1"></td>
</tr>

<tr>
    <td>Sonido</td>
    <td id="numberMsg2"></td>
</tr>

</tbody>
</table>
<div  style="display: table; margin-right: auto; margin-left: auto;">
    <table border="0">
        <tr>
            <td>
                <div align="center"  id="chart_div" style="width: 150px; height: 120px;"></div>  
            </td>

            <td>
                <div align="center"  id="chart_div2" style="width: 150px; height: 120px;"></div>  
            </td>
        </tr>
    </table>
</div>
<div class='table'>

</div>
<div class='table'>
    <table>
        <tr>
            <td style='vertical-align: middle !important;'>
                LED:
            </td>
            <td>
                <input name="led" checked='checked' class='yesno' type='checkbox' />
            </td>
        </tr>
    </table>
</div>
</body>
</html>